<!DOCTYPE html>
<html>
<head>
    <title>Debug Calendar Leave Dates</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        pre { background: #f4f4f4; padding: 10px; border-radius: 4px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Debug Calendar Leave Dates</h1>
    <button onclick="testDates()">Test Date Formatting</button>
    <button onclick="fetchLeaves()">Fetch Leaves from API</button>
    <div id="output"></div>

    <script>
        const formatDateForAPI = (date) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        function testDates() {
            const output = document.getElementById('output');
            let html = '<h2>Date Formatting Tests</h2>';

            // Test October 1st specifically
            const oct1 = new Date(2025, 9, 1); // Month is 0-indexed
            html += `<div class="info">Creating: new Date(2025, 9, 1)</div>`;
            html += `<pre>Date object: ${oct1.toString()}</pre>`;
            html += `<pre>ISO String: ${oct1.toISOString()}</pre>`;
            html += `<pre>formatDateForAPI: ${formatDateForAPI(oct1)}</pre>`;

            // Test with string parsing
            const oct1FromString = new Date('2025-10-01');
            html += `<div class="info">Creating: new Date('2025-10-01')</div>`;
            html += `<pre>Date object: ${oct1FromString.toString()}</pre>`;
            html += `<pre>ISO String: ${oct1FromString.toISOString()}</pre>`;
            html += `<pre>formatDateForAPI: ${formatDateForAPI(oct1FromString)}</pre>`;

            // Test other dates for comparison
            const oct15 = new Date(2025, 9, 15);
            html += `<div class="info">Creating: new Date(2025, 9, 15)</div>`;
            html += `<pre>formatDateForAPI: ${formatDateForAPI(oct15)}</pre>`;

            output.innerHTML = html;
        }

        async function fetchLeaves() {
            const output = document.getElementById('output');
            let html = '<h2>API Response Test</h2>';

            try {
                const token = localStorage.getItem('timewise-auth-token');
                const startDate = '2025-10-01';
                const endDate = '2025-10-31';
                const timestamp = new Date().getTime();

                html += `<div class="info">Fetching: /api/leaves?startDate=${startDate}&endDate=${endDate}</div>`;

                const response = await fetch(`/api/leaves?startDate=${startDate}&endDate=${endDate}&_t=${timestamp}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache'
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    html += `<div class="success">✓ API Response OK</div>`;
                    html += `<pre>${JSON.stringify(result, null, 2)}</pre>`;

                    if (result.data && result.data.leaves) {
                        html += '<h3>Processed Leave Dates:</h3>';
                        const leaveDateStrings = new Set(
                            result.data.leaves.map((leave) => formatDateForAPI(new Date(leave.date)))
                        );
                        html += `<pre>${JSON.stringify(Array.from(leaveDateStrings), null, 2)}</pre>`;

                        // Check if Oct 1 is in the set
                        const hasOct1 = leaveDateStrings.has('2025-10-01');
                        html += hasOct1
                            ? '<div class="success">✓ October 1st IS in the leave dates set</div>'
                            : '<div class="error">✗ October 1st is NOT in the leave dates set</div>';
                    }
                } else {
                    html += `<div class="error">✗ API Error: ${response.status} ${response.statusText}</div>`;
                    const errorText = await response.text();
                    html += `<pre>${errorText}</pre>`;
                }
            } catch (error) {
                html += `<div class="error">✗ Error: ${error.message}</div>`;
            }

            output.innerHTML = html;
        }
    </script>
</body>
</html>
